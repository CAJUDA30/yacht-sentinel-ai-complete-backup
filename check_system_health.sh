#!/bin/bash
echo "üîç YACHT SENTINEL AI - COMPREHENSIVE SYSTEM HEALTH CHECK"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

# Configuration
DB_URL="postgresql://postgres:postgres@127.0.0.1:54322/postgres"
ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0"
API_URL="http://127.0.0.1:54321"

# Initialize counters for final assessment
ISSUE_COUNT=0
WARNING_COUNT=0

echo "‚ïë CORE SERVICES HEALTH                                        ‚ïë"
echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"

# Check Supabase status
if npx supabase status > /dev/null 2>&1; then
    echo "‚ïë ‚úÖ Supabase Services: RUNNING                               ‚ïë"
else
    echo "‚ïë ‚ùå Supabase Services: NOT RUNNING                           ‚ïë"
    ((ISSUE_COUNT++))
    echo "‚ïë    ‚Üí Run: npx supabase start                                ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    exit 1
fi

echo "‚ïë                                                              ‚ïë"
echo "‚ïë DATABASE INFRASTRUCTURE                                      ‚ïë"
echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"

# Check Database Tables
TABLE_COUNT=$(psql "$DB_URL" -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';" 2>/dev/null | tr -d ' ')
if [ "$TABLE_COUNT" -ge "15" ]; then
    printf "‚ïë ‚úÖ Database Tables: %-38s ‚ïë\n" "$TABLE_COUNT tables"
else
    printf "‚ïë ‚ö†Ô∏è  Database Tables: %-38s ‚ïë\n" "$TABLE_COUNT tables (expected 15+)"
    ((WARNING_COUNT++))
fi

# Check Migrations
MIGRATION_STATUS=$(npx supabase migration list --local 2>/dev/null | grep -c "Applied" || echo "0")
MIGRATION_PENDING=$(npx supabase migration list --local 2>/dev/null | grep -c "Pending" || echo "0")
# Clean up the values to ensure they're numeric
MIGRATION_STATUS=$(echo "$MIGRATION_STATUS" | tr -d '\n' | tr -d ' ')
MIGRATION_PENDING=$(echo "$MIGRATION_PENDING" | tr -d '\n' | tr -d ' ')
if [ "$MIGRATION_PENDING" = "0" ]; then
    printf "‚ïë ‚úÖ Migrations: %-42s ‚ïë\n" "$MIGRATION_STATUS applied, 0 pending"
else
    printf "‚ïë ‚ö†Ô∏è  Migrations: %-42s ‚ïë\n" "$MIGRATION_STATUS applied, $MIGRATION_PENDING pending"
    ((WARNING_COUNT++))
fi

# Check RLS Policies
RLS_COUNT=$(psql "$DB_URL" -t -c "SELECT COUNT(*) FROM pg_policies;" 2>/dev/null | tr -d ' ')
if [ "$RLS_COUNT" -ge "10" ]; then
    printf "‚ïë ‚úÖ RLS Policies: %-40s ‚ïë\n" "$RLS_COUNT policies active"
else
    printf "‚ïë ‚ö†Ô∏è  RLS Policies: %-40s ‚ïë\n" "$RLS_COUNT policies (expected 10+)"
    ((WARNING_COUNT++))
fi

# Check RPC Functions
FUNCTION_COUNT=$(psql "$DB_URL" -t -c "SELECT COUNT(*) FROM information_schema.routines WHERE routine_schema = 'public' AND routine_type = 'FUNCTION';" 2>/dev/null | tr -d ' ')
if [ "$FUNCTION_COUNT" -ge "5" ]; then
    printf "‚ïë ‚úÖ RPC Functions: %-39s ‚ïë\n" "$FUNCTION_COUNT functions"
else
    printf "‚ïë ‚ö†Ô∏è  RPC Functions: %-39s ‚ïë\n" "$FUNCTION_COUNT functions (expected 5+)"
    ((WARNING_COUNT++))
fi

# Check Edge Functions
EDGE_FUNCTIONS_DIR="supabase/functions"
if [ -d "$EDGE_FUNCTIONS_DIR" ]; then
    # Count actual function directories (each function should have its own directory)
    EDGE_FUNCTION_COUNT=$(find "$EDGE_FUNCTIONS_DIR" -mindepth 1 -maxdepth 1 -type d | wc -l | tr -d ' ')
    if [ "$EDGE_FUNCTION_COUNT" -ge "1" ]; then
        printf "‚ïë ‚úÖ Edge Functions: %-38s ‚ïë\n" "$EDGE_FUNCTION_COUNT functions deployed"
    else
        printf "‚ïë ‚ö†Ô∏è  Edge Functions: %-38s ‚ïë\n" "No functions found"
        ((WARNING_COUNT++))
    fi
else
    EDGE_FUNCTION_COUNT=0
    printf "‚ïë ‚ö†Ô∏è  Edge Functions: %-38s ‚ïë\n" "Directory not found"
    ((WARNING_COUNT++))
fi

echo "‚ïë                                                              ‚ïë"
echo "‚ïë DATA INTEGRITY                                               ‚ïë"
echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"

# Check Data Records - Core Tables
USER_COUNT=$(psql "$DB_URL" -t -c "SELECT COUNT(*) FROM auth.users;" 2>/dev/null | tr -d ' ')
if [ "$USER_COUNT" -ge "1" ]; then
    printf "‚ïë ‚úÖ Data Records (Users): %-32s ‚ïë\n" "$USER_COUNT users"
else
    printf "‚ïë ‚ùå Data Records (Users): %-32s ‚ïë\n" "No users found"
    ((ISSUE_COUNT++))
fi

# Check superadmin user specifically
SUPERADMIN_EXISTS=$(psql "$DB_URL" -t -c "SELECT COUNT(*) FROM auth.users WHERE email = 'superadmin@yachtexcel.com';" 2>/dev/null | tr -d ' ')
if [ "$SUPERADMIN_EXISTS" = "1" ]; then
    printf "‚ïë ‚úÖ Superadmin User: %-37s ‚ïë\n" "CONFIGURED"
else
    printf "‚ïë ‚ùå Superadmin User: %-37s ‚ïë\n" "MISSING"
    ((ISSUE_COUNT++))
fi

# Check Document AI processors
PROCESSOR_COUNT=$(psql "$DB_URL" -t -c "SELECT COUNT(*) FROM public.document_ai_processors WHERE is_active = true;" 2>/dev/null | tr -d ' ')
if [ "$PROCESSOR_COUNT" -ge "3" ]; then
    printf "‚ïë ‚úÖ Document AI Processors: %-30s ‚ïë\n" "$PROCESSOR_COUNT active"
else
    printf "‚ïë ‚ö†Ô∏è  Document AI Processors: %-30s ‚ïë\n" "$PROCESSOR_COUNT active (expected 3+)"
    ((WARNING_COUNT++))
fi

# Check yacht data
YACHT_COUNT=$(psql "$DB_URL" -t -c "SELECT COUNT(*) FROM public.yachts;" 2>/dev/null | tr -d ' ' | tr -d '\n')
if [ -z "$YACHT_COUNT" ] || ! [[ "$YACHT_COUNT" =~ ^[0-9]+$ ]]; then
    YACHT_COUNT="0"
fi
if [ "$YACHT_COUNT" -ge "1" ]; then
    printf "‚ïë ‚úÖ Sample Yacht Data: %-34s ‚ïë\n" "$YACHT_COUNT yachts"
else
    printf "‚ïë ‚ö†Ô∏è  Sample Yacht Data: %-34s ‚ïë\n" "No sample data"
    ((WARNING_COUNT++))
fi

# Check role permissions
PERMISSION_COUNT=$(psql "$DB_URL" -t -c "SELECT COUNT(*) FROM public.role_permissions;" 2>/dev/null | tr -d ' ' | tr -d '\n')
# Ensure we have a valid number, handle table not existing
if [ -z "$PERMISSION_COUNT" ] || ! [[ "$PERMISSION_COUNT" =~ ^[0-9]+$ ]]; then
    PERMISSION_COUNT="0"
    printf "‚ïë ‚ùå Role Permissions: %-36s ‚ïë\n" "Table missing (CRITICAL)"
    ((ISSUE_COUNT++))
elif [ "$PERMISSION_COUNT" -ge "20" ]; then
    printf "‚ïë ‚úÖ Role Permissions: %-36s ‚ïë\n" "$PERMISSION_COUNT permissions"
else
    printf "‚ïë ‚ùå Role Permissions: %-36s ‚ïë\n" "$PERMISSION_COUNT permissions (need 20+)"
    ((ISSUE_COUNT++))
fi

echo "‚ïë                                                              ‚ïë"
echo "‚ïë API CONNECTIVITY                                             ‚ïë"
echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"

# Test REST API endpoint
if curl -sf "$API_URL/rest/v1/document_ai_processors" -H "apikey: $ANON_KEY" > /dev/null 2>&1; then
    printf "‚ïë ‚úÖ REST API Endpoints: %-34s ‚ïë\n" "RESPONSIVE"
else
    # Fallback test with basic rest endpoint to check if service is up
    if curl -sf "$API_URL/rest/v1/" -H "apikey: $ANON_KEY" > /dev/null 2>&1; then
        printf "‚ïë ‚úÖ REST API Endpoints: %-34s ‚ïë\n" "RESPONSIVE (basic)"
    else
        # Final test - check if REST service responds at all (even with errors)
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/rest/v1/" -H "apikey: $ANON_KEY" 2>/dev/null)
        if [ "$HTTP_CODE" -ge "200" ] && [ "$HTTP_CODE" -lt "500" ]; then
            printf "‚ïë ‚úÖ REST API Endpoints: %-34s ‚ïë\n" "RESPONSIVE (HTTP $HTTP_CODE)"
        else
            printf "‚ïë ‚ùå REST API Endpoints: %-34s ‚ïë\n" "NOT RESPONDING"
            ((ISSUE_COUNT++))
        fi
    fi
fi

# Test Auth API endpoint
if curl -sf "$API_URL/auth/v1/health" > /dev/null 2>&1; then
    printf "‚ïë ‚úÖ Auth API Endpoints: %-34s ‚ïë\n" "RESPONSIVE"
else
    # Try settings endpoint as fallback
    if curl -sf "$API_URL/auth/v1/settings" -H "apikey: $ANON_KEY" > /dev/null 2>&1; then
        printf "‚ïë ‚úÖ Auth API Endpoints: %-34s ‚ïë\n" "RESPONSIVE"
    else
        # Check if auth service is running by testing signup endpoint (should return method info)
        if curl -sf "$API_URL/auth/v1/signup" -H "apikey: $ANON_KEY" -X OPTIONS > /dev/null 2>&1; then
            printf "‚ïë ‚úÖ Auth API Endpoints: %-34s ‚ïë\n" "RESPONSIVE"
        else
            printf "‚ïë ‚ö†Ô∏è  Auth API Endpoints: %-34s ‚ïë\n" "LIMITED/DOWN"
            ((WARNING_COUNT++))
        fi
    fi
fi

# Test Edge Functions endpoint (if any exist)
if [ "$EDGE_FUNCTION_COUNT" -ge "1" ]; then
    # Try to test if edge functions service is available
    # First check if we have a known function to test
    if [ -d "supabase/functions/gcp-unified-config" ]; then
        # Test specific function endpoint
        if curl -sf "$API_URL/functions/v1/gcp-unified-config" -H "apikey: $ANON_KEY" -X OPTIONS > /dev/null 2>&1; then
            printf "‚ïë ‚úÖ Edge Functions API: %-33s ‚ïë\n" "RESPONSIVE"
        else
            printf "‚ïë ‚ö†Ô∏è  Edge Functions API: %-33s ‚ïë\n" "LIMITED ACCESS"
            ((WARNING_COUNT++))
        fi
    else
        # Test generic functions endpoint
        if curl -sf "$API_URL/functions/v1/" -H "apikey: $ANON_KEY" > /dev/null 2>&1; then
            printf "‚ïë ‚úÖ Edge Functions API: %-33s ‚ïë\n" "RESPONSIVE"
        else
            printf "‚ïë ‚ö†Ô∏è  Edge Functions API: %-33s ‚ïë\n" "SERVICE DOWN"
            ((WARNING_COUNT++))
        fi
    fi
else
    printf "‚ïë ‚ûñ Edge Functions API: %-33s ‚ïë\n" "N/A (no functions)"
fi

echo "‚ïë                                                              ‚ïë"
echo "‚ïë SYSTEM SUMMARY                                               ‚ïë"
echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"

# Calculate overall health score
TOTAL_CHECKS=15
HEALTHY_CHECKS=$((TOTAL_CHECKS - ISSUE_COUNT - WARNING_COUNT))
HEALTH_PERCENTAGE=$((HEALTHY_CHECKS * 100 / TOTAL_CHECKS))

printf "‚ïë üìä System Health Score: %-32s ‚ïë\n" "$HEALTH_PERCENTAGE% ($HEALTHY_CHECKS/$TOTAL_CHECKS)"
printf "‚ïë ‚ùå Critical Issues: %-37s ‚ïë\n" "$ISSUE_COUNT"
printf "‚ïë ‚ö†Ô∏è  Warnings: %-45s ‚ïë\n" "$WARNING_COUNT"

echo "‚ïë                                                              ‚ïë"
echo "‚ïë RECOMMENDATIONS                                              ‚ïë"
echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"

if [ "$ISSUE_COUNT" -gt "0" ]; then
    echo "‚ïë üö® CRITICAL: System requires immediate attention             ‚ïë"
    if [ "$PERMISSION_COUNT" = "0" ]; then
        echo "‚ïë    ‚Üí Missing permissions: npx supabase migration up --local   ‚ïë"
        echo "‚ïë    ‚Üí Then reset: npx supabase db reset --local             ‚ïë"
    else
        echo "‚ïë    ‚Üí Auth issues: Check Supabase auth configuration        ‚ïë"
    fi
    echo "‚ïë    ‚Üí Full recovery: ./restore_superadmin_improved.sh         ‚ïë"
elif [ "$WARNING_COUNT" -gt "3" ]; then
    echo "‚ïë ‚ö†Ô∏è  WARNING: Several components need attention               ‚ïë"
    if [ "$YACHT_COUNT" = "0" ]; then
        echo "‚ïë    ‚Üí No sample data (normal for new systems)                ‚ïë"
        echo "‚ïë    ‚Üí Optional: Add sample yachts via frontend              ‚ïë"
    else
        echo "‚ïë    ‚Üí Check migration status: npx supabase migration list   ‚ïë"
    fi
elif [ "$WARNING_COUNT" -gt "0" ]; then
    echo "‚ïë ‚ú® GOOD: System is mostly healthy with minor warnings       ‚ïë"
    if [ "$YACHT_COUNT" = "0" ]; then
        echo "‚ïë    ‚Üí Missing sample data is normal for new installations   ‚ïë"
    fi
    echo "‚ïë    ‚Üí Review warnings above for optimization opportunities   ‚ïë"
else
    echo "‚ïë üéâ EXCELLENT: All systems are running optimally!            ‚ïë"
    echo "‚ïë    ‚Üí System is ready for development and production use     ‚ïë"
fi

echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"

# Exit with appropriate code
if [ "$ISSUE_COUNT" -gt "0" ]; then
    exit 1
elif [ "$WARNING_COUNT" -gt "3" ]; then
    exit 2
else
    exit 0
fi