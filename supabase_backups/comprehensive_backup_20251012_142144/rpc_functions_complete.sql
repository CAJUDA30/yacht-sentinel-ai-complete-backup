          info           
-------------------------
 -- RPC FUNCTIONS BACKUP
(1 row)

                    info                    
--------------------------------------------
 -- Generated: 2025-10-12 12:21:45.28825+00
(1 row)

 ?column? 
----------
 
(1 row)

                                                                                                         function_definition                                                                                                          
LEGACY_API_KEY_REDACTED_FOR_GITHUB_SECURITY-----------------------------------------------------------------------------------------------------
 CREATE OR REPLACE FUNCTION public.assign_default_user_role()                                                                                                                                                                        +
  RETURNS trigger                                                                                                                                                                                                                    +
  LANGUAGE plpgsql                                                                                                                                                                                                                   +
  SECURITY DEFINER                                                                                                                                                                                                                   +
  SET search_path TO 'public', 'auth'                                                                                                                                                                                                +
 AS $function$                                                                                                                                                                                                                       +
 DECLARE                                                                                                                                                                                                                             +
     user_role text;                                                                                                                                                                                                                 +
     role_exists boolean;                                                                                                                                                                                                            +
 BEGIN                                                                                                                                                                                                                               +
     -- Determine role from user metadata or email (priority order)                                                                                                                                                                  +
     IF NEW.raw_user_meta_data ? 'role' THEN                                                                                                                                                                                         +
         user_role := NEW.raw_user_meta_data->>'role';                                                                                                                                                                               +
     ELSIF NEW.email = 'superadmin@yachtexcel.com' THEN                                                                                                                                                                              +
         user_role := 'superadmin';                                                                                                                                                                                                  +
     ELSE                                                                                                                                                                                                                            +
         user_role := 'user';                                                                                                                                                                                                        +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     -- Validate role is allowed                                                                                                                                                                                                     +
     IF user_role NOT IN ('guest', 'viewer', 'user', 'manager', 'admin', 'superadmin') THEN                                                                                                                                          +
         user_role := 'user'; -- Default to safe role                                                                                                                                                                                +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     -- Check if role already exists (prevent duplicate work in high concurrency)                                                                                                                                                    +
     SELECT EXISTS (                                                                                                                                                                                                                 +
         SELECT 1 FROM public.user_roles                                                                                                                                                                                             +
         WHERE user_id = NEW.id                                                                                                                                                                                                      +
         AND role = user_role                                                                                                                                                                                                        +
         AND department IS NULL                                                                                                                                                                                                      +
     ) INTO role_exists;                                                                                                                                                                                                             +
                                                                                                                                                                                                                                     +
     -- Only insert if doesn't exist (optimized for scalability)                                                                                                                                                                     +
     IF NOT role_exists THEN                                                                                                                                                                                                         +
         BEGIN                                                                                                                                                                                                                       +
             -- CRITICAL: Explicit department=NULL to match unique constraint                                                                                                                                                        +
             INSERT INTO public.user_roles (user_id, role, department, granted_by, is_active)                                                                                                                                        +
             VALUES (NEW.id, user_role, NULL, NEW.id, true)                                                                                                                                                                          +
             ON CONFLICT (user_id, role, COALESCE(department, ''))                                                                                                                                                                   +
             DO UPDATE SET                                                                                                                                                                                                           +
                 is_active = true,                                                                                                                                                                                                   +
                 updated_at = now();                                                                                                                                                                                                 +
         EXCEPTION                                                                                                                                                                                                                   +
             WHEN unique_violation THEN                                                                                                                                                                                              +
                 -- Race condition handled - another process already inserted                                                                                                                                                        +
                 NULL;                                                                                                                                                                                                               +
             WHEN OTHERS THEN                                                                                                                                                                                                        +
                 -- Log but don't fail user creation (critical for production)                                                                                                                                                       +
                 RAISE WARNING '[assign_default_user_role] Failed for user % (role: %): %', NEW.id, user_role, SQLERRM;                                                                                                              +
         END;                                                                                                                                                                                                                        +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     RETURN NEW;                                                                                                                                                                                                                     +
 END;                                                                                                                                                                                                                                +
 $function$                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                     +
 
 CREATE OR REPLACE FUNCTION public.assign_user_role(_user_id uuid, _role text, _department text DEFAULT NULL::text, _granted_by uuid DEFAULT NULL::uuid, _expires_at timestamp with time zone DEFAULT NULL::timestamp with time zone)+
  RETURNS boolean                                                                                                                                                                                                                    +
  LANGUAGE plpgsql                                                                                                                                                                                                                   +
  SECURITY DEFINER                                                                                                                                                                                                                   +
 AS $function$                                                                                                                                                                                                                       +
 DECLARE                                                                                                                                                                                                                             +
     granter_id UUID;                                                                                                                                                                                                                +
 BEGIN                                                                                                                                                                                                                               +
     granter_id := COALESCE(_granted_by, auth.uid());                                                                                                                                                                                +
                                                                                                                                                                                                                                     +
     -- Check if caller has permission to assign roles                                                                                                                                                                               +
     IF NOT public.user_has_permission('write', 'roles', 'assign_standard', granter_id) THEN                                                                                                                                         +
         RAISE EXCEPTION 'Insufficient permissions to assign roles';                                                                                                                                                                 +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     -- Prevent non-superadmins from assigning superadmin role                                                                                                                                                                       +
     IF _role = 'superadmin' AND NOT public.is_superadmin(granter_id) THEN                                                                                                                                                           +
         RAISE EXCEPTION 'Only superadmins can assign superadmin role';                                                                                                                                                              +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     INSERT INTO public.user_roles (                                                                                                                                                                                                 +
         user_id, role, department, granted_by, expires_at                                                                                                                                                                           +
     ) VALUES (                                                                                                                                                                                                                      +
         _user_id, _role, _department, granter_id, _expires_at                                                                                                                                                                       +
     )                                                                                                                                                                                                                               +
     ON CONFLICT (user_id, role, COALESCE(department, ''))                                                                                                                                                                           +
     DO UPDATE SET                                                                                                                                                                                                                   +
         is_active = true,                                                                                                                                                                                                           +
         granted_by = granter_id,                                                                                                                                                                                                    +
         expires_at = _expires_at,                                                                                                                                                                                                   +
         updated_at = NOW();                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     RETURN TRUE;                                                                                                                                                                                                                    +
 END;                                                                                                                                                                                                                                +
 $function$                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                     +
 
 CREATE OR REPLACE FUNCTION public.auto_encrypt_ai_provider_keys()                                                                                                                                                                   +
  RETURNS trigger                                                                                                                                                                                                                    +
  LANGUAGE plpgsql                                                                                                                                                                                                                   +
  SECURITY DEFINER                                                                                                                                                                                                                   +
 AS $function$                                                                                                                                                                                                                       +
 BEGIN                                                                                                                                                                                                                               +
     -- Encrypt API key from various possible sources                                                                                                                                                                                +
     -- Priority: api_key_encrypted > config.api_key > api_secret_name                                                                                                                                                               +
                                                                                                                                                                                                                                     +
     -- 1. If api_key_encrypted is being set directly                                                                                                                                                                                +
     IF NEW.api_key_encrypted IS NOT NULL AND NEW.api_key_encrypted != '' THEN                                                                                                                                                       +
         NEW.api_key_encrypted := public.encrypt_api_key(NEW.api_key_encrypted);                                                                                                                                                     +
     -- 2. Check if API key is in config.api_key                                                                                                                                                                                     +
     ELSIF NEW.config IS NOT NULL AND NEW.config ? 'api_key' THEN                                                                                                                                                                    +
         NEW.api_key_encrypted := public.encrypt_api_key(NEW.config->>'api_key');                                                                                                                                                    +
         -- Remove plain text key from config after encryption                                                                                                                                                                       +
         NEW.config := NEW.config - 'api_key';                                                                                                                                                                                       +
     -- 3. Check if API key is in api_secret_name (legacy)                                                                                                                                                                           +
     ELSIF NEW.api_secret_name IS NOT NULL AND NEW.api_secret_name != '' THEN                                                                                                                                                        +
         NEW.api_key_encrypted := public.encrypt_api_key(NEW.api_secret_name);                                                                                                                                                       +
         NEW.api_secret_name := NULL; -- Clear after encryption                                                                                                                                                                      +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     RETURN NEW;                                                                                                                                                                                                                     +
 END;                                                                                                                                                                                                                                +
 $function$                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                     +
 
 CREATE OR REPLACE FUNCTION public.auto_encrypt_document_ai_credentials()                                                                                                                                                            +
  RETURNS trigger                                                                                                                                                                                                                    +
  LANGUAGE plpgsql                                                                                                                                                                                                                   +
  SECURITY DEFINER                                                                                                                                                                                                                   +
 AS $function$                                                                                                                                                                                                                       +
 BEGIN                                                                                                                                                                                                                               +
     -- Encrypt GCP service account credentials                                                                                                                                                                                      +
     IF NEW.gcp_service_account_encrypted IS NOT NULL AND NEW.gcp_service_account_encrypted != '' THEN                                                                                                                               +
         NEW.gcp_service_account_encrypted := public.encrypt_api_key(NEW.gcp_service_account_encrypted);                                                                                                                             +
     -- Check if credentials are in configuration.gcp_service_account                                                                                                                                                                +
     ELSIF NEW.configuration IS NOT NULL AND NEW.configuration ? 'gcp_service_account' THEN                                                                                                                                          +
         NEW.gcp_service_account_encrypted := public.encrypt_api_key(NEW.configuration->>'gcp_service_account');                                                                                                                     +
         -- Remove plain text from config after encryption                                                                                                                                                                           +
         NEW.configuration := NEW.configuration - 'gcp_service_account';                                                                                                                                                             +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     -- Encrypt generic GCP credentials                                                                                                                                                                                              +
     IF NEW.gcp_credentials_encrypted IS NOT NULL AND NEW.gcp_credentials_encrypted != '' THEN                                                                                                                                       +
         NEW.gcp_credentials_encrypted := public.encrypt_api_key(NEW.gcp_credentials_encrypted);                                                                                                                                     +
     -- Check if credentials are in configuration.gcp_credentials                                                                                                                                                                    +
     ELSIF NEW.configuration IS NOT NULL AND NEW.configuration ? 'gcp_credentials' THEN                                                                                                                                              +
         NEW.gcp_credentials_encrypted := public.encrypt_api_key(NEW.configuration->>'gcp_credentials');                                                                                                                             +
         -- Remove plain text from config after encryption                                                                                                                                                                           +
         NEW.configuration := NEW.configuration - 'gcp_credentials';                                                                                                                                                                 +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     RETURN NEW;                                                                                                                                                                                                                     +
 END;                                                                                                                                                                                                                                +
 $function$                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                     +
 
 CREATE OR REPLACE FUNCTION public.check_user_creation_health()                                                                                                                                                                      +
  RETURNS TABLE(metric text, value bigint, status text)                                                                                                                                                                              +
  LANGUAGE plpgsql                                                                                                                                                                                                                   +
  SECURITY DEFINER                                                                                                                                                                                                                   +
 AS $function$                                                                                                                                                                                                                       +
 BEGIN                                                                                                                                                                                                                               +
     RETURN QUERY                                                                                                                                                                                                                    +
     SELECT                                                                                                                                                                                                                          +
         'total_users'::TEXT,                                                                                                                                                                                                        +
         COUNT(*)::BIGINT,                                                                                                                                                                                                           +
         CASE WHEN COUNT(*) > 0 THEN 'healthy' ELSE 'warning' END::TEXT                                                                                                                                                              +
     FROM auth.users                                                                                                                                                                                                                 +
     UNION ALL                                                                                                                                                                                                                       +
     SELECT                                                                                                                                                                                                                          +
         'total_profiles'::TEXT,                                                                                                                                                                                                     +
         COUNT(*)::BIGINT,                                                                                                                                                                                                           +
         CASE WHEN COUNT(*) > 0 THEN 'healthy' ELSE 'warning' END::TEXT                                                                                                                                                              +
     FROM public.user_profiles                                                                                                                                                                                                       +
     UNION ALL                                                                                                                                                                                                                       +
     SELECT                                                                                                                                                                                                                          +
         'total_roles'::TEXT,                                                                                                                                                                                                        +
         COUNT(*)::BIGINT,                                                                                                                                                                                                           +
         CASE WHEN COUNT(*) > 0 THEN 'healthy' ELSE 'warning' END::TEXT                                                                                                                                                              +
     FROM public.user_roles                                                                                                                                                                                                          +
     UNION ALL                                                                                                                                                                                                                       +
     SELECT                                                                                                                                                                                                                          +
         'users_without_roles'::TEXT,                                                                                                                                                                                                +
         COUNT(*)::BIGINT,                                                                                                                                                                                                           +
         CASE WHEN COUNT(*) = 0 THEN 'healthy' ELSE 'critical' END::TEXT                                                                                                                                                             +
     FROM auth.users u                                                                                                                                                                                                               +
     WHERE NOT EXISTS (SELECT 1 FROM public.user_roles r WHERE r.user_id = u.id)                                                                                                                                                     +
     UNION ALL                                                                                                                                                                                                                       +
     SELECT                                                                                                                                                                                                                          +
         'users_without_profiles'::TEXT,                                                                                                                                                                                             +
         COUNT(*)::BIGINT,                                                                                                                                                                                                           +
         CASE WHEN COUNT(*) = 0 THEN 'healthy' ELSE 'warning' END::TEXT                                                                                                                                                              +
     FROM auth.users u                                                                                                                                                                                                               +
     WHERE NOT EXISTS (SELECT 1 FROM public.user_profiles p WHERE p.user_id = u.id);                                                                                                                                                 +
 END;                                                                                                                                                                                                                                +
 $function$                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                     +
 
 CREATE OR REPLACE FUNCTION public.check_user_permission(permission_name text)                                                                                                                                                       +
  RETURNS boolean                                                                                                                                                                                                                    +
  LANGUAGE plpgsql                                                                                                                                                                                                                   +
  STABLE SECURITY DEFINER                                                                                                                                                                                                            +
 AS $function$                                                                                                                                                                                                                       +
 DECLARE                                                                                                                                                                                                                             +
     user_email text;                                                                                                                                                                                                                +
     user_role text;                                                                                                                                                                                                                 +
 BEGIN                                                                                                                                                                                                                               +
     -- Get current user email                                                                                                                                                                                                       +
     SELECT email INTO user_email                                                                                                                                                                                                    +
     FROM auth.users                                                                                                                                                                                                                 +
     WHERE id = auth.uid();                                                                                                                                                                                                          +
                                                                                                                                                                                                                                     +
     -- Check if superadmin                                                                                                                                                                                                          +
     IF user_email = 'superadmin@yachtexcel.com' THEN                                                                                                                                                                                +
         RETURN true;                                                                                                                                                                                                                +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     -- Get user role                                                                                                                                                                                                                +
     SELECT role INTO user_role                                                                                                                                                                                                      +
     FROM public.user_roles                                                                                                                                                                                                          +
     WHERE user_id = auth.uid()                                                                                                                                                                                                      +
     LIMIT 1;                                                                                                                                                                                                                        +
                                                                                                                                                                                                                                     +
     -- Basic permission checks                                                                                                                                                                                                      +
     CASE                                                                                                                                                                                                                            +
         WHEN permission_name = 'read' THEN                                                                                                                                                                                          +
             RETURN true; -- All authenticated users can read                                                                                                                                                                        +
         WHEN permission_name = 'write' AND user_role IN ('admin', 'superadmin') THEN                                                                                                                                                +
             RETURN true;                                                                                                                                                                                                            +
         WHEN permission_name = 'delete' AND user_role = 'superadmin' THEN                                                                                                                                                           +
             RETURN true;                                                                                                                                                                                                            +
         ELSE                                                                                                                                                                                                                        +
             RETURN false;                                                                                                                                                                                                           +
     END CASE;                                                                                                                                                                                                                       +
 END;                                                                                                                                                                                                                                +
 $function$                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                     +
 
 CREATE OR REPLACE FUNCTION public.current_user_is_superadmin()                                                                                                                                                                      +
  RETURNS boolean                                                                                                                                                                                                                    +
  LANGUAGE plpgsql                                                                                                                                                                                                                   +
  SECURITY DEFINER                                                                                                                                                                                                                   +
 AS $function$                                                                                                                                                                                                                       +
 BEGIN                                                                                                                                                                                                                               +
     RETURN public.is_superadmin(auth.uid());                                                                                                                                                                                        +
 END;                                                                                                                                                                                                                                +
 $function$                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                     +
 
 CREATE OR REPLACE FUNCTION public.decrypt_api_key(encrypted_key text)                                                                                                                                                               +
  RETURNS text                                                                                                                                                                                                                       +
  LANGUAGE plpgsql                                                                                                                                                                                                                   +
  SECURITY DEFINER                                                                                                                                                                                                                   +
 AS $function$                                                                                                                                                                                                                       +
 DECLARE                                                                                                                                                                                                                             +
     encryption_key TEXT;                                                                                                                                                                                                            +
     decrypted_value TEXT;                                                                                                                                                                                                           +
 BEGIN                                                                                                                                                                                                                               +
     -- Return NULL for empty input                                                                                                                                                                                                  +
     IF encrypted_key IS NULL OR encrypted_key = '' THEN                                                                                                                                                                             +
         RETURN NULL;                                                                                                                                                                                                                +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     -- If already plain text, return as-is (backward compatibility)                                                                                                                                                                 +
     IF NOT public.is_encrypted(encrypted_key) THEN                                                                                                                                                                                  +
         -- Remove PLAIN: prefix if present                                                                                                                                                                                          +
         IF encrypted_key LIKE 'PLAIN:%' THEN                                                                                                                                                                                        +
             RETURN substring(encrypted_key from 7);                                                                                                                                                                                 +
         END IF;                                                                                                                                                                                                                     +
         RETURN encrypted_key;                                                                                                                                                                                                       +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     -- Get encryption key                                                                                                                                                                                                           +
     SELECT COALESCE(                                                                                                                                                                                                                +
         current_setting('app.encryption_key', true),                                                                                                                                                                                +
         'yacht-sentinel-encryption-key-2024'                                                                                                                                                                                        +
     ) INTO encryption_key;                                                                                                                                                                                                          +
                                                                                                                                                                                                                                     +
     -- Decrypt using pgcrypto                                                                                                                                                                                                       +
     BEGIN                                                                                                                                                                                                                           +
         SELECT convert_from(                                                                                                                                                                                                        +
             decrypt(                                                                                                                                                                                                                +
                 decode(encrypted_key, 'base64'),                                                                                                                                                                                    +
                 encryption_key::bytea,                                                                                                                                                                                              +
                 'aes'                                                                                                                                                                                                               +
             ),                                                                                                                                                                                                                      +
             'UTF8'                                                                                                                                                                                                                  +
         ) INTO decrypted_value;                                                                                                                                                                                                     +
                                                                                                                                                                                                                                     +
         RETURN decrypted_value;                                                                                                                                                                                                     +
     EXCEPTION WHEN OTHERS THEN                                                                                                                                                                                                      +
         -- If decryption fails, return original value (legacy plain text)                                                                                                                                                           +
         RAISE WARNING 'Decryption failed for API key, returning as plain text: %', SQLERRM;                                                                                                                                         +
         RETURN encrypted_key;                                                                                                                                                                                                       +
     END;                                                                                                                                                                                                                            +
 END;                                                                                                                                                                                                                                +
 $function$                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                     +
 
 CREATE OR REPLACE FUNCTION public.encrypt_api_key(plain_key text)                                                                                                                                                                   +
  RETURNS text                                                                                                                                                                                                                       +
  LANGUAGE plpgsql                                                                                                                                                                                                                   +
  SECURITY DEFINER                                                                                                                                                                                                                   +
 AS $function$                                                                                                                                                                                                                       +
 DECLARE                                                                                                                                                                                                                             +
     encryption_key TEXT;                                                                                                                                                                                                            +
 BEGIN                                                                                                                                                                                                                               +
     -- Return NULL for empty input                                                                                                                                                                                                  +
     IF plain_key IS NULL OR plain_key = '' THEN                                                                                                                                                                                     +
         RETURN NULL;                                                                                                                                                                                                                +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     -- If already encrypted, return as-is                                                                                                                                                                                           +
     IF public.is_encrypted(plain_key) THEN                                                                                                                                                                                          +
         RETURN plain_key;                                                                                                                                                                                                           +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     -- Remove PLAIN: prefix if present                                                                                                                                                                                              +
     IF plain_key LIKE 'PLAIN:%' THEN                                                                                                                                                                                                +
         plain_key := substring(plain_key from 7);                                                                                                                                                                                   +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     -- Get or generate encryption key                                                                                                                                                                                               +
     -- In production, this should come from environment variables                                                                                                                                                                   +
     -- For now, use a consistent key stored in a secure table                                                                                                                                                                       +
     SELECT COALESCE(                                                                                                                                                                                                                +
         current_setting('app.encryption_key', true),                                                                                                                                                                                +
         'yacht-sentinel-encryption-key-2024'  -- Default fallback                                                                                                                                                                   +
     ) INTO encryption_key;                                                                                                                                                                                                          +
                                                                                                                                                                                                                                     +
     -- Encrypt using pgcrypto (AES-256)                                                                                                                                                                                             +
     -- Returns base64 encoded encrypted data                                                                                                                                                                                        +
     BEGIN                                                                                                                                                                                                                           +
         RETURN encode(                                                                                                                                                                                                              +
             encrypt(                                                                                                                                                                                                                +
                 plain_key::bytea,                                                                                                                                                                                                   +
                 encryption_key::bytea,                                                                                                                                                                                              +
                 'aes'                                                                                                                                                                                                               +
             ),                                                                                                                                                                                                                      +
             'base64'                                                                                                                                                                                                                +
         );                                                                                                                                                                                                                          +
     EXCEPTION WHEN OTHERS THEN                                                                                                                                                                                                      +
         -- If encryption fails, return with PLAIN: prefix for identification                                                                                                                                                        +
         RAISE WARNING 'Encryption failed for API key, storing as PLAIN: %', SQLERRM;                                                                                                                                                +
         RETURN 'PLAIN:' || plain_key;                                                                                                                                                                                               +
     END;                                                                                                                                                                                                                            +
 END;                                                                                                                                                                                                                                +
 $function$                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                     +
 
 CREATE OR REPLACE FUNCTION public.ensure_superadmin_role()                                                                                                                                                                          +
  RETURNS trigger                                                                                                                                                                                                                    +
  LANGUAGE plpgsql                                                                                                                                                                                                                   +
  SECURITY DEFINER                                                                                                                                                                                                                   +
  SET search_path TO 'public', 'auth'                                                                                                                                                                                                +
 AS $function$                                                                                                                                                                                                                       +
 DECLARE                                                                                                                                                                                                                             +
     is_superadmin_user boolean;                                                                                                                                                                                                     +
     role_exists boolean;                                                                                                                                                                                                            +
 BEGIN                                                                                                                                                                                                                               +
     -- Multiple checks for superadmin detection (defense in depth)                                                                                                                                                                  +
     is_superadmin_user := (                                                                                                                                                                                                         +
         NEW.email = 'superadmin@yachtexcel.com' OR                                                                                                                                                                                  +
         NEW.is_super_admin = true OR                                                                                                                                                                                                +
         (NEW.raw_user_meta_data ? 'is_superadmin' AND                                                                                                                                                                               +
          (NEW.raw_user_meta_data->>'is_superadmin')::boolean = true) OR                                                                                                                                                             +
         (NEW.raw_user_meta_data ? 'role' AND                                                                                                                                                                                        +
          NEW.raw_user_meta_data->>'role' = 'superadmin')                                                                                                                                                                            +
     );                                                                                                                                                                                                                              +
                                                                                                                                                                                                                                     +
     IF is_superadmin_user THEN                                                                                                                                                                                                      +
         -- Check if superadmin role already exists                                                                                                                                                                                  +
         SELECT EXISTS (                                                                                                                                                                                                             +
             SELECT 1 FROM public.user_roles                                                                                                                                                                                         +
             WHERE user_id = NEW.id                                                                                                                                                                                                  +
             AND role = 'superadmin'                                                                                                                                                                                                 +
             AND department IS NULL                                                                                                                                                                                                  +
         ) INTO role_exists;                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
         -- Only insert if doesn't exist                                                                                                                                                                                             +
         IF NOT role_exists THEN                                                                                                                                                                                                     +
             BEGIN                                                                                                                                                                                                                   +
                 -- CRITICAL: Explicit department=NULL to match unique constraint                                                                                                                                                    +
                 INSERT INTO public.user_roles (user_id, role, department, granted_by, is_active)                                                                                                                                    +
                 VALUES (NEW.id, 'superadmin', NULL, NEW.id, true)                                                                                                                                                                   +
                 ON CONFLICT (user_id, role, COALESCE(department, ''))                                                                                                                                                               +
                 DO UPDATE SET                                                                                                                                                                                                       +
                     is_active = true,                                                                                                                                                                                               +
                     updated_at = now();                                                                                                                                                                                             +
             EXCEPTION                                                                                                                                                                                                               +
                 WHEN unique_violation THEN                                                                                                                                                                                          +
                     NULL; -- Race condition handled                                                                                                                                                                                 +
                 WHEN OTHERS THEN                                                                                                                                                                                                    +
                     RAISE WARNING '[ensure_superadmin_role] Failed for user %: %', NEW.id, SQLERRM;                                                                                                                                 +
             END;                                                                                                                                                                                                                    +
         END IF;                                                                                                                                                                                                                     +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     RETURN NEW;                                                                                                                                                                                                                     +
 END;                                                                                                                                                                                                                                +
 $function$                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                     +
 
 CREATE OR REPLACE FUNCTION public.ensure_user_role(user_id_param uuid, role_param text DEFAULT 'user'::text)                                                                                                                        +
  RETURNS void                                                                                                                                                                                                                       +
  LANGUAGE plpgsql                                                                                                                                                                                                                   +
  SECURITY DEFINER                                                                                                                                                                                                                   +
 AS $function$                                                                                                                                                                                                                       +
 BEGIN                                                                                                                                                                                                                               +
     -- Insert role if it doesn't exist                                                                                                                                                                                              +
     INSERT INTO public.user_roles (user_id, role, created_at, updated_at)                                                                                                                                                           +
     VALUES (user_id_param, role_param, NOW(), NOW())                                                                                                                                                                                +
     ON CONFLICT (user_id, role)                                                                                                                                                                                                     +
     DO UPDATE SET updated_at = NOW();                                                                                                                                                                                               +
 END;                                                                                                                                                                                                                                +
 $function$                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                     +
 
 CREATE OR REPLACE FUNCTION public.get_user_roles(_user_id uuid DEFAULT NULL::uuid)                                                                                                                                                  +
  RETURNS TABLE(role text, department text, is_active boolean, expires_at timestamp with time zone)                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                   +
  SECURITY DEFINER                                                                                                                                                                                                                   +
 AS $function$                                                                                                                                                                                                                       +
 DECLARE                                                                                                                                                                                                                             +
     target_user_id UUID;                                                                                                                                                                                                            +
 BEGIN                                                                                                                                                                                                                               +
     target_user_id := COALESCE(_user_id, auth.uid());                                                                                                                                                                               +
                                                                                                                                                                                                                                     +
     IF target_user_id IS NULL THEN                                                                                                                                                                                                  +
         RETURN;                                                                                                                                                                                                                     +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     RETURN QUERY                                                                                                                                                                                                                    +
     SELECT                                                                                                                                                                                                                          +
         ur.role,                                                                                                                                                                                                                    +
         ur.department,                                                                                                                                                                                                              +
         ur.is_active,                                                                                                                                                                                                               +
         ur.expires_at                                                                                                                                                                                                               +
     FROM public.user_roles ur                                                                                                                                                                                                       +
     WHERE ur.user_id = target_user_id                                                                                                                                                                                               +
     AND ur.is_active = true                                                                                                                                                                                                         +
     AND (ur.expires_at IS NULL OR ur.expires_at > NOW())                                                                                                                                                                            +
     ORDER BY                                                                                                                                                                                                                        +
         CASE ur.role                                                                                                                                                                                                                +
             WHEN 'superadmin' THEN 1                                                                                                                                                                                                +
             WHEN 'admin' THEN 2                                                                                                                                                                                                     +
             WHEN 'manager' THEN 3                                                                                                                                                                                                   +
             WHEN 'user' THEN 4                                                                                                                                                                                                      +
             WHEN 'viewer' THEN 5                                                                                                                                                                                                    +
             ELSE 6                                                                                                                                                                                                                  +
         END;                                                                                                                                                                                                                        +
 END;                                                                                                                                                                                                                                +
 $function$                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                     +
 
 CREATE OR REPLACE FUNCTION public.handle_new_user_signup()                                                                                                                                                                          +
  RETURNS trigger                                                                                                                                                                                                                    +
  LANGUAGE plpgsql                                                                                                                                                                                                                   +
  SECURITY DEFINER                                                                                                                                                                                                                   +
  SET search_path TO 'public', 'auth'                                                                                                                                                                                                +
 AS $function$                                                                                                                                                                                                                       +
 DECLARE                                                                                                                                                                                                                             +
     user_role TEXT;                                                                                                                                                                                                                 +
     display_name_value TEXT;                                                                                                                                                                                                        +
     profile_exists boolean;                                                                                                                                                                                                         +
     role_exists boolean;                                                                                                                                                                                                            +
 BEGIN                                                                                                                                                                                                                               +
     -- ========================================================================                                                                                                                                                     +
     -- STEP 1: Create User Profile (with existence check)                                                                                                                                                                           +
     -- ========================================================================                                                                                                                                                     +
                                                                                                                                                                                                                                     +
     -- Determine display name                                                                                                                                                                                                       +
     display_name_value := COALESCE(                                                                                                                                                                                                 +
         NEW.raw_user_meta_data->>'name',                                                                                                                                                                                            +
         NEW.raw_user_meta_data->>'display_name',                                                                                                                                                                                    +
         split_part(NEW.email, '@', 1)                                                                                                                                                                                               +
     );                                                                                                                                                                                                                              +
                                                                                                                                                                                                                                     +
     -- Check if profile already exists (prevent duplicate work)                                                                                                                                                                     +
     SELECT EXISTS (                                                                                                                                                                                                                 +
         SELECT 1 FROM public.user_profiles WHERE user_id = NEW.id                                                                                                                                                                   +
     ) INTO profile_exists;                                                                                                                                                                                                          +
                                                                                                                                                                                                                                     +
     IF NOT profile_exists THEN                                                                                                                                                                                                      +
         BEGIN                                                                                                                                                                                                                       +
             INSERT INTO public.user_profiles (user_id, display_name)                                                                                                                                                                +
             VALUES (NEW.id, display_name_value)                                                                                                                                                                                     +
             ON CONFLICT (user_id) DO UPDATE SET                                                                                                                                                                                     +
                 display_name = COALESCE(EXCLUDED.display_name, public.user_profiles.display_name),                                                                                                                                  +
                 updated_at = now();                                                                                                                                                                                                 +
         EXCEPTION                                                                                                                                                                                                                   +
             WHEN unique_violation THEN                                                                                                                                                                                              +
                 NULL; -- Already exists                                                                                                                                                                                             +
             WHEN OTHERS THEN                                                                                                                                                                                                        +
                 -- Log but continue (profile is not critical for auth)                                                                                                                                                              +
                 RAISE WARNING '[handle_new_user_signup] Profile creation failed for %: %', NEW.id, SQLERRM;                                                                                                                         +
         END;                                                                                                                                                                                                                        +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     -- ========================================================================                                                                                                                                                     +
     -- STEP 2: Smart Role Assignment (Hierarchical & Scalable)                                                                                                                                                                      +
     -- ========================================================================                                                                                                                                                     +
                                                                                                                                                                                                                                     +
     -- Priority-based role assignment                                                                                                                                                                                               +
     IF NEW.email = 'superadmin@yachtexcel.com' THEN                                                                                                                                                                                 +
         user_role := 'superadmin';                                                                                                                                                                                                  +
     ELSIF NEW.raw_user_meta_data ? 'role' THEN                                                                                                                                                                                      +
         -- Respect role from metadata (for API-based signups)                                                                                                                                                                       +
         user_role := NEW.raw_user_meta_data->>'role';                                                                                                                                                                               +
         -- Validate role                                                                                                                                                                                                            +
         IF user_role NOT IN ('guest', 'viewer', 'user', 'manager', 'admin', 'superadmin') THEN                                                                                                                                      +
             user_role := 'user';                                                                                                                                                                                                    +
         END IF;                                                                                                                                                                                                                     +
     ELSIF NEW.email LIKE '%@yachtexcel.com' THEN                                                                                                                                                                                    +
         user_role := 'admin'; -- Company domain gets admin                                                                                                                                                                          +
     ELSIF NEW.email LIKE '%admin%' OR NEW.email LIKE '%manager%' THEN                                                                                                                                                               +
         user_role := 'manager'; -- Email pattern detection                                                                                                                                                                          +
     ELSE                                                                                                                                                                                                                            +
         user_role := 'user'; -- Default safe role                                                                                                                                                                                   +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     -- Check if role already exists                                                                                                                                                                                                 +
     SELECT EXISTS (                                                                                                                                                                                                                 +
         SELECT 1 FROM public.user_roles                                                                                                                                                                                             +
         WHERE user_id = NEW.id                                                                                                                                                                                                      +
         AND role = user_role                                                                                                                                                                                                        +
         AND department IS NULL                                                                                                                                                                                                      +
     ) INTO role_exists;                                                                                                                                                                                                             +
                                                                                                                                                                                                                                     +
     -- Only insert if doesn't exist                                                                                                                                                                                                 +
     IF NOT role_exists THEN                                                                                                                                                                                                         +
         BEGIN                                                                                                                                                                                                                       +
             -- CRITICAL: Explicit department=NULL to match unique constraint                                                                                                                                                        +
             INSERT INTO public.user_roles (user_id, role, department, granted_by, is_active)                                                                                                                                        +
             VALUES (NEW.id, user_role, NULL, NEW.id, true)                                                                                                                                                                          +
             ON CONFLICT (user_id, role, COALESCE(department, ''))                                                                                                                                                                   +
             DO UPDATE SET                                                                                                                                                                                                           +
                 is_active = true,                                                                                                                                                                                                   +
                 granted_by = NEW.id,                                                                                                                                                                                                +
                 updated_at = now();                                                                                                                                                                                                 +
         EXCEPTION                                                                                                                                                                                                                   +
             WHEN unique_violation THEN                                                                                                                                                                                              +
                 NULL; -- Race condition handled                                                                                                                                                                                     +
             WHEN OTHERS THEN                                                                                                                                                                                                        +
                 -- Log but don't fail user creation (CRITICAL for production)                                                                                                                                                       +
                 RAISE WARNING '[handle_new_user_signup] Role assignment failed for % (role: %): %', NEW.id, user_role, SQLERRM;                                                                                                     +
         END;                                                                                                                                                                                                                        +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     RETURN NEW;                                                                                                                                                                                                                     +
 END;                                                                                                                                                                                                                                +
 $function$                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                     +
 
 CREATE OR REPLACE FUNCTION public.handle_updated_at()                                                                                                                                                                               +
  RETURNS trigger                                                                                                                                                                                                                    +
  LANGUAGE plpgsql                                                                                                                                                                                                                   +
 AS $function$                                                                                                                                                                                                                       +
 BEGIN                                                                                                                                                                                                                               +
     NEW.updated_at = NOW();                                                                                                                                                                                                         +
     RETURN NEW;                                                                                                                                                                                                                     +
 END;                                                                                                                                                                                                                                +
 $function$                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                     +
 
 CREATE OR REPLACE FUNCTION public.is_encrypted(value text)                                                                                                                                                                          +
  RETURNS boolean                                                                                                                                                                                                                    +
  LANGUAGE plpgsql                                                                                                                                                                                                                   +
  IMMUTABLE                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                       +
 BEGIN                                                                                                                                                                                                                               +
     -- Empty values are not encrypted                                                                                                                                                                                               +
     IF value IS NULL OR value = '' THEN                                                                                                                                                                                             +
         RETURN FALSE;                                                                                                                                                                                                               +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     -- Check for known plain text API key prefixes                                                                                                                                                                                  +
     -- These indicate the key is NOT encrypted                                                                                                                                                                                      +
     IF value ~ '^(sk-|xai-|claude-|glpat-|AIza|PLAIN:)' THEN                                                                                                                                                                        +
         RETURN FALSE;                                                                                                                                                                                                               +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     -- Check if it looks like base64 encoded data (encrypted)                                                                                                                                                                       +
     -- Base64 should only contain A-Z, a-z, 0-9, +, /, and = for padding                                                                                                                                                            +
     -- and should be reasonably long (at least 32 characters for encrypted data)                                                                                                                                                    +
     IF value ~ '^[A-Za-z0-9+/]+={0,2}$' AND length(value) >= 32 THEN                                                                                                                                                                +
         RETURN TRUE;                                                                                                                                                                                                                +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     -- Default: treat as plain text                                                                                                                                                                                                 +
     RETURN FALSE;                                                                                                                                                                                                                   +
 END;                                                                                                                                                                                                                                +
 $function$                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                     +
 
 CREATE OR REPLACE FUNCTION public.is_superadmin(_user_id uuid DEFAULT NULL::uuid)                                                                                                                                                   +
  RETURNS boolean                                                                                                                                                                                                                    +
  LANGUAGE plpgsql                                                                                                                                                                                                                   +
  SECURITY DEFINER                                                                                                                                                                                                                   +
 AS $function$                                                                                                                                                                                                                       +
 DECLARE                                                                                                                                                                                                                             +
     target_user_id UUID;                                                                                                                                                                                                            +
     user_email TEXT;                                                                                                                                                                                                                +
 BEGIN                                                                                                                                                                                                                               +
     -- Use provided user_id or get current user                                                                                                                                                                                     +
     target_user_id := COALESCE(_user_id, auth.uid());                                                                                                                                                                               +
                                                                                                                                                                                                                                     +
     -- Return false if no user                                                                                                                                                                                                      +
     IF target_user_id IS NULL THEN                                                                                                                                                                                                  +
         RETURN FALSE;                                                                                                                                                                                                               +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     -- Get user email from auth.users                                                                                                                                                                                               +
     SELECT email INTO user_email                                                                                                                                                                                                    +
     FROM auth.users                                                                                                                                                                                                                 +
     WHERE id = target_user_id;                                                                                                                                                                                                      +
                                                                                                                                                                                                                                     +
     -- PRIORITY 1: Email-based superadmin detection (HIGHEST PRIORITY)                                                                                                                                                              +
     IF user_email = 'superadmin@yachtexcel.com' THEN                                                                                                                                                                                +
         RETURN TRUE;                                                                                                                                                                                                                +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     -- PRIORITY 2: Check user_roles table for explicit superadmin role                                                                                                                                                              +
     IF EXISTS (                                                                                                                                                                                                                     +
         SELECT 1                                                                                                                                                                                                                    +
         FROM public.user_roles                                                                                                                                                                                                      +
         WHERE user_id = target_user_id                                                                                                                                                                                              +
         AND role = 'superadmin'                                                                                                                                                                                                     +
         AND is_active = true                                                                                                                                                                                                        +
     ) THEN                                                                                                                                                                                                                          +
         RETURN TRUE;                                                                                                                                                                                                                +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     -- Default: not superadmin                                                                                                                                                                                                      +
     RETURN FALSE;                                                                                                                                                                                                                   +
 END;                                                                                                                                                                                                                                +
 $function$                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                     +
 
 CREATE OR REPLACE FUNCTION public.is_superadmin()                                                                                                                                                                                   +
  RETURNS boolean                                                                                                                                                                                                                    +
  LANGUAGE plpgsql                                                                                                                                                                                                                   +
  SECURITY DEFINER                                                                                                                                                                                                                   +
 AS $function$                                                                                                                                                                                                                       +
 BEGIN                                                                                                                                                                                                                               +
     RETURN public.is_superadmin(auth.uid());                                                                                                                                                                                        +
 END;                                                                                                                                                                                                                                +
 $function$                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                     +
 
 CREATE OR REPLACE FUNCTION public.is_superadmin_by_email(user_id uuid DEFAULT NULL::uuid)                                                                                                                                           +
  RETURNS boolean                                                                                                                                                                                                                    +
  LANGUAGE sql                                                                                                                                                                                                                       +
  STABLE SECURITY DEFINER                                                                                                                                                                                                            +
 AS $function$                                                                                                                                                                                                                       +
     SELECT EXISTS (                                                                                                                                                                                                                 +
         SELECT 1 FROM auth.users                                                                                                                                                                                                    +
         WHERE id = COALESCE(user_id, auth.uid())                                                                                                                                                                                    +
         AND email = 'superadmin@yachtexcel.com'                                                                                                                                                                                     +
     );                                                                                                                                                                                                                              +
 $function$                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                     +
 
 CREATE OR REPLACE FUNCTION public.sync_ai_provider_config()                                                                                                                                                                         +
  RETURNS trigger                                                                                                                                                                                                                    +
  LANGUAGE plpgsql                                                                                                                                                                                                                   +
 AS $function$                                                                                                                                                                                                                       +
 BEGIN                                                                                                                                                                                                                               +
   -- If config is updated, copy to configuration                                                                                                                                                                                    +
   IF NEW.config IS DISTINCT FROM OLD.config THEN                                                                                                                                                                                    +
     NEW.configuration := NEW.config;                                                                                                                                                                                                +
   END IF;                                                                                                                                                                                                                           +
                                                                                                                                                                                                                                     +
   -- If configuration is updated, copy to config                                                                                                                                                                                    +
   IF NEW.configuration IS DISTINCT FROM OLD.configuration THEN                                                                                                                                                                      +
     NEW.config := NEW.configuration;                                                                                                                                                                                                +
   END IF;                                                                                                                                                                                                                           +
                                                                                                                                                                                                                                     +
   RETURN NEW;                                                                                                                                                                                                                       +
 END;                                                                                                                                                                                                                                +
 $function$                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                     +
 
 CREATE OR REPLACE FUNCTION public.user_has_permission(_permission text, _resource text DEFAULT NULL::text, _action text DEFAULT NULL::text, _user_id uuid DEFAULT NULL::uuid)                                                       +
  RETURNS boolean                                                                                                                                                                                                                    +
  LANGUAGE plpgsql                                                                                                                                                                                                                   +
  SECURITY DEFINER                                                                                                                                                                                                                   +
 AS $function$                                                                                                                                                                                                                       +
 DECLARE                                                                                                                                                                                                                             +
     target_user_id UUID;                                                                                                                                                                                                            +
     has_permission BOOLEAN DEFAULT FALSE;                                                                                                                                                                                           +
     user_roles TEXT[];                                                                                                                                                                                                              +
 BEGIN                                                                                                                                                                                                                               +
     target_user_id := COALESCE(_user_id, auth.uid());                                                                                                                                                                               +
                                                                                                                                                                                                                                     +
     IF target_user_id IS NULL THEN                                                                                                                                                                                                  +
         RETURN FALSE;                                                                                                                                                                                                               +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     -- Get user's active roles                                                                                                                                                                                                      +
     SELECT ARRAY_AGG(role) INTO user_roles                                                                                                                                                                                          +
     FROM public.user_roles ur                                                                                                                                                                                                       +
     WHERE ur.user_id = target_user_id                                                                                                                                                                                               +
     AND ur.is_active = true                                                                                                                                                                                                         +
     AND (ur.expires_at IS NULL OR ur.expires_at > NOW());                                                                                                                                                                           +
                                                                                                                                                                                                                                     +
     -- If no roles, return false                                                                                                                                                                                                    +
     IF user_roles IS NULL OR array_length(user_roles, 1) = 0 THEN                                                                                                                                                                   +
         RETURN FALSE;                                                                                                                                                                                                               +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     -- Check if user has superadmin role (grants all permissions)                                                                                                                                                                   +
     IF 'superadmin' = ANY(user_roles) THEN                                                                                                                                                                                          +
         RETURN TRUE;                                                                                                                                                                                                                +
     END IF;                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                     +
     -- Check specific permissions                                                                                                                                                                                                   +
     SELECT EXISTS (                                                                                                                                                                                                                 +
         SELECT 1                                                                                                                                                                                                                    +
         FROM public.role_permissions rp                                                                                                                                                                                             +
         WHERE rp.role = ANY(user_roles)                                                                                                                                                                                             +
         AND rp.permission = _permission                                                                                                                                                                                             +
         AND (_resource IS NULL OR rp.resource = _resource OR rp.resource = '*')                                                                                                                                                     +
         AND (_action IS NULL OR rp.action = _action OR rp.action = '*')                                                                                                                                                             +
     ) INTO has_permission;                                                                                                                                                                                                          +
                                                                                                                                                                                                                                     +
     RETURN has_permission;                                                                                                                                                                                                          +
 END;                                                                                                                                                                                                                                +
 $function$                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                     +
 
(20 rows)

